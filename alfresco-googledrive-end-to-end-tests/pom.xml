<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <artifactId>alfresco-googledrive-end-to-end-tests</artifactId>
    <version>4.0.0-A1-SNAPSHOT</version>
    <packaging>jar</packaging>
    <name>Alfresco / Google Drive E2E Tests</name>

    <parent>
        <artifactId>alfresco-googledrive</artifactId>
        <groupId>org.alfresco.integrations</groupId>
        <version>4.0.0-A1-SNAPSHOT</version>
    </parent>

    <dependencies>
        <dependency>
            <groupId>org.seleniumhq.selenium</groupId>
            <artifactId>selenium-java</artifactId>
            <version>3.141.59</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.13.1</version>
            <scope>test</scope>
        </dependency>

    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <configuration>
                    <skip>true</skip>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <configuration>
                    <skip>true</skip>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-deploy-plugin</artifactId>
                <configuration>
                    <skip>true</skip>
                </configuration>
            </plugin>
        </plugins>
    </build>

    <profiles>
        <profile>
            <id>docker-end-to-end-setup</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-failsafe-plugin</artifactId>
                        <configuration combine.self="override">
                            <skip>false</skip>
                        </configuration>
                    </plugin>

                    <plugin>
                        <groupId>io.fabric8</groupId>
                        <artifactId>docker-maven-plugin</artifactId>
                        <version>0.33.0</version>
                        <extensions>true</extensions>
                        <configuration>
                            <apiVersion>1.29</apiVersion>
                            <imagePullPolicy>IfNotPresent</imagePullPolicy>
                            <removeMode>all</removeMode>
                            <autoCreateCustomNetworks>true</autoCreateCustomNetworks>
                            <images>
                                <image>
                                    <alias>selenium</alias>
                                    <name>selenium/standalone-chrome:102.0</name>
                                    <run>
                                        <hostname>selenium</hostname>
                                        <network>
                                            <name>alfresco</name>
                                            <alias>selenium</alias>
                                        </network>
                                        <ports>
                                            <port>4444:4444</port>
                                        </ports>
                                    </run>
                                </image>
                                <image>
                                    <alias>postgres</alias>
                                    <name>postgres:11.7</name>
                                    <run>
                                        <hostname>postgres</hostname>
                                        <network>
                                            <name>alfresco</name>
                                            <alias>postgres</alias>
                                        </network>
                                        <ports>
                                            <port>5432:5432</port>
                                        </ports>
                                        <env>
                                            <POSTGRES_PASSWORD>alfresco</POSTGRES_PASSWORD>
                                            <POSTGRES_USER>alfresco</POSTGRES_USER>
                                            <POSTGRES_DB>alfresco</POSTGRES_DB>
                                        </env>
                                        <volumes>
                                            <bind>
                                                <volume>db-volume:/var/lib/postgresql/data</volume>
                                            </bind>
                                        </volumes>
                                    </run>
                                </image>
                                <image>
                                    <alias>activemq</alias>
                                    <name>alfresco/alfresco-activemq:5.18.2-jre17-rockylinux8</name>
                                    <run>
                                        <hostname>activemq</hostname>
                                        <network>
                                            <name>alfresco</name>
                                            <alias>activemq</alias>
                                        </network>
                                        <ports>
                                            <port>8161:8161</port>
                                            <port>5672:5672</port>
                                            <port>61616:61616</port>
                                        </ports>
                                        <wait>
                                            <log>Apache ActiveMQ 5.* started</log>
                                            <time>20000</time>
                                            <kill>500</kill>
                                            <shutdown>100</shutdown>
                                        </wait>
                                    </run>
                                </image>

                                <image>
                                    <alias>alfresco</alias>
                                    <name>alfresco/alfresco-content-repository-gd</name>
                                    <run>
                                        <hostname>alfresco</hostname>
                                        <network>
                                            <name>alfresco</name>
                                            <alias>alfresco</alias>
                                        </network>
                                        <ports>
                                            <!--<port>5006:5006</port>-->
                                            <port>8080:8080</port>
                                        </ports>
                                        <env>
                                            <!--<CATALINA_OPTS>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5006</CATALINA_OPTS>-->
                                            <JAVA_OPTS>-Xms1500m -Xmx1500m -Ddeployment.method=DOCKER_COMPOSE -Ddb.driver=org.postgresql.Driver -Ddb.url=jdbc:postgresql://postgres:5432/alfresco -Ddb.username=alfresco -Ddb.password=alfresco -Dmessaging.broker.url=nio://activemq:61616?jms.useCompression=true -Dsolr.host=solr6 -Dsolr.port=8983 -Dsolr.secureComms=secret -Dsolr.sharedSecret=secret -Dsolr.base.url=/solr -Dindex.subsystem.name=solr6 -Dshare.host=127.0.0.1 -Dshare.port=8080 -Dalfresco.host=localhost -Dalfresco.port=8080 -Daos.baseUrlOverwrite=http://localhost:8080/alfresco/aos -Dtransform.service.enabled=false -Dlocal.transform.service.enabled=false -Dlegacy.transform.service.enabled=true -Dcsrf.filter.enabled=false -Dencryption.keystore.type=JCEKS -Dencryption.cipherAlgorithm=DESede/CBC/PKCS5Padding -Dencryption.keyAlgorithm=DESede -Dencryption.keystore.location=/usr/local/tomcat/shared/classes/alfresco/extension/keystore/keystore -Dmetadata-keystore.password=mp6yc0UD9e -Dmetadata-keystore.aliases=metadata -Dmetadata-keystore.metadata.password=oKIWzVdEdA -Dmetadata-keystore.metadata.algorithm=DESede -Ddsync.messaging.events.repo.node.target.endpoint=jms:topic:VirtualTopic.alfresco.repo.events.nodes?jmsMessageType=Text
                                            </JAVA_OPTS>
                                        </env>
                                        <dependsOn>
                                            <container>activemq</container>
                                            <container>postgres</container>
                                            <container>solr6</container>
                                        </dependsOn>
                                        <wait>
                                            <http>
                                                <url>http://localhost:8080/alfresco/</url>
                                                <method>GET</method>
                                                <status>200...299</status>
                                            </http>
                                            <time>600000</time>
                                            <kill>500</kill>
                                            <shutdown>100</shutdown>
                                        </wait>
                                        <volumes>
                                            <bind>
                                                <volume>alfresco-volume:/usr/local/tomcat/alf_data</volume>
                                            </bind>
                                        </volumes>
                                    </run>
                                </image>

                                <image>
                                    <alias>share</alias>
                                    <name>alfresco/alfresco-share-gd</name>
                                    <run>
                                        <hostname>share</hostname>
                                        <network>
                                            <name>alfresco</name>
                                            <alias>share</alias>
                                        </network>
                                        <ports>
                                            <port>8181:8080</port>
                                        </ports>
                                        <env>
                                            <REPO_HOST>alfresco</REPO_HOST>
                                            <REPO_PORT>8080</REPO_PORT>
                                            <CSRF_FILTER_REFERER />
                                            <CSRF_FILTER_ORIGIN />
                                        </env>
                                        <wait>
                                            <http>
                                                <url>http://localhost:8181/share</url>
                                                <method>GET</method>
                                                <status>200...399</status>
                                            </http>
                                            <time>60000</time>
                                        </wait>
                                    </run>
                                </image>

                                <image>
                                    <alias>solr6</alias>
                                    <name>quay.io/alfresco/search-services:2.0.3</name>
                                    <run>
                                        <hostname>solr6</hostname>
                                        <network>
                                            <name>alfresco</name>
                                            <alias>solr6</alias>
                                        </network>
                                        <ports>
                                            <port>8083:8083</port>
                                        </ports>
                                        <env>
                                            <SOLR_ALFRESCO_HOST>alfresco</SOLR_ALFRESCO_HOST>
                                            <SOLR_ALFRESCO_PORT>8080</SOLR_ALFRESCO_PORT>
                                            <SOLR_SOLR_HOST>solr6</SOLR_SOLR_HOST>
                                            <SOLR_SOLR_PORT>8983</SOLR_SOLR_PORT>
                                            <SOLR_CREATE_ALFRESCO_DEFAULTS>alfresco,archive</SOLR_CREATE_ALFRESCO_DEFAULTS>
                                        </env>
                                        <volumes>
                                            <bind>
                                                <volume>solr-volume:/opt/alfresco-search-services/contentstore</volume>
                                            </bind>
                                        </volumes>
                                        <volumes>
                                            <bind>
                                                <volume>solr-volume:/opt/alfresco-search-services/data</volume>
                                            </bind>
                                        </volumes>
                                    </run>
                                </image>
                            </images>
                        </configuration>
                        <executions>
                            <execution>
                                <id>before-integration-tests</id>
                                <phase>pre-integration-test</phase>
                                <goals>
                                    <goal>stop</goal>
                                    <goal>volume-create</goal>
                                    <goal>start</goal>
                                </goals>
                            </execution>
                            <execution>
                                <id>after-integration-tests</id>
                                <phase>post-integration-test</phase>
                                <goals>
                                    <goal>stop</goal>
                                    <goal>volume-remove</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>
</project>